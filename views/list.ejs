<% layout('layouts/boilerplate') %>
  <div class="container mt-4">
    <div class="row">
      <div class="col-10 offset-1">
        <h3 class="text-center mb-4"><%= list.title %></h3>
      </div>
    </div>

    <!-- Card Section -->
    <div class="card shadow-lg p-3 mb-4 bg-white rounded col-6 offset-3 show-card">
      <img src="<%= list.image.url %>" class="card-img-top show-img rounded" alt="listing image">
      <div class="card-body text-center">
        <h5 class="card-title fw-bold"><%= (list.owner && list.owner.email) ? list.owner.email : 'Owner' %></h5>
        <p class="card-text text-muted"><%= list.description %></p>
        <p class="mb-1"><b>Price:</b> ‚Çπ<%= list.price %></p>
        <p class="mb-1"><b>Location:</b> <%= list.location %></p>
        <p><b>Country:</b> <%= list.country %></p>
      </div>
    </div>

    <!-- Buttons Section -->

   <% if(currentUser && currentUser._id.toString() === list.owner._id.toString()) { %>
    <div class="d-flex justify-content-center gap-3 mb-5">
      <form action="/listing/<%= list._id %>/edit" method="get">
        <button class="btn btn-warning px-4">‚úèÔ∏è Edit</button>
      </form>

      <form action="/listing/<%= list._id %>/delete?_method=DELETE" method="post">
        <button class="btn btn-danger px-4">üóëÔ∏è Delete</button>
      </form>
    </div>
    <% } %>
    <hr>
    <% if(currentUser) { %>
    <div class="col-6 offset-3">
      <label for="review" class="form-label">Add a Review</label>
      <form action="/listing/<%= list._id %>/review" method="post" class="mb-5 needs-validation" novalidate id="reviewForm">
        <div class="mb-3">
          <!-- Star Rating -->
          <div class="mb-3">
            <label class="form-label">Rating:</label>
            <div class="star-rating" id="starRating" style="font-size: 2rem; color: #ffc107;">
              <% for(let i=5; i>=1; i--) { %>
                <input type="radio" id="star<%= i %>" name="rating" value="<%= i %>" style="display:none;" <%= i === 3 ? 'checked' : '' %>>
                <label for="star<%= i %>" style="cursor:pointer;">&#9733;</label>
              <% } %>
            </div>
          </div>
          <label for="comment">Add a Comment</label>
          <textarea name="comment" class="form-control" rows="3" required></textarea>
          <div class="invalid-feedback">
            Please provide a valid review.
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Submit Review</button>
       
      </form>
    </div>
    
    <hr>
    <% } %>
   <div class="col-6 offset-3 mb-5">
  <h4 class="mb-4 text-center fw-bold">User Reviews ‚≠ê</h4>

  <% if (list.reviews.length === 0) { %>
    <p class="text-muted text-center">No reviews yet. Be the first to review!</p>
  <% } else { %>
    <% list.reviews.forEach(review => { %>
      <div class="card mb-4 shadow-sm review-card animate__animated animate__fadeInUp">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">
              <% for(let i=1; i<=5; i++) { %>
                <% if(i <= review.Rating) { %>
                  <span style="color: #ffc107; font-size: 1.2rem;">&#9733;</span>
                <% } else { %>
                  <span style="color: #e4e5e9; font-size: 1.2rem;">&#9733;</span>
                <% } %>
              <% } %>
              <span class="ms-2 text-muted small">(<%= review.Rating %>/5)</span>
            </h5>
            <% if(currentUser && currentUser._id.toString() === review.author._id.toString()) { %>
              <form action="/listing/<%= list._id %>/review/<%= review._id %>?_method=DELETE" method="post">
                <button class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
              </form>
            <% } %>
          </div>
          <p class="card-text"><%= review.Comment %></p>
          <p class="text-end mb-0">
            
            <small class="text-muted">by <b><%= review.author.email %></b></small>
          </p>
        </div>
      </div>
    <% }) %>
  <% } %>
</div>

  </div>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const stars = document.querySelectorAll('#starRating label');
  const radios = document.querySelectorAll('#starRating input[type="radio"]');
  const starRatingDiv = document.getElementById('starRating');

  // Initialize selection
  let selectedValue = document.querySelector('#starRating input:checked')?.value || 3;

  function highlightStars(value) {
    stars.forEach((star, idx) => {
      const starVal = 5 - idx;
      star.style.color = starVal <= value ? '#ffc107' : '#e4e5e9';
    });
  }

  highlightStars(selectedValue);

  stars.forEach((star, idx) => {
    const starVal = 5 - idx;

    star.addEventListener('mouseenter', () => highlightStars(starVal));
    star.addEventListener('mouseleave', () => highlightStars(selectedValue));

    star.addEventListener('click', () => {
      selectedValue = starVal;
      radios[idx].checked = true;
      highlightStars(selectedValue);
      starRatingDiv.classList.add('selected');
      setTimeout(() => starRatingDiv.classList.remove('selected'), 300);
    });
  });
});
</script>
